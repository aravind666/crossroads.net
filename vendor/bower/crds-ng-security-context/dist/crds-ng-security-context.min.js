(function(){angular.module("crdsSecurityContext",["crdsAuth"])}).call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};angular.module("crdsSecurityContext").run(["SecurityContext",function(e){return e.loadCurrentUser()}]).provider("SecurityContext",function(){var t;console.log("SecurityContext provider factory"),t=30,this.setSessionMinutes=function(e){return t=e},this.$get=["$q","$rootScope","$localStorage","Auth",function(n,r,o,s){var u,i,l;return console.log("SecurityContext.$get, using sessionMinutes "+t),l=new(function(){function r(){this.login=e(this.login,this),this.loadCurrentUser=e(this.loadCurrentUser,this),this.userId=null,this.user=null,this.loggedIn=null,this.seenDate=null}return r.prototype.loadCurrentUser=function(){var e,n,r;n=o.securityContext,n&&(r=new Date(o.seenDate),isNaN(r.getTime())?(console.log("User session date is invalid"),u()):(e=((new Date).getTime()-r.getTime())/1e3/60,t>=e?(this.user=n,this.userId=n.id,this.loggedIn=!0,this.seenDate=new Date):(console.log("User session has expired"),u()))),i()},r.prototype.login=function(e,t){var r,o;return u(),this.loggedIn=null,r=n.defer(),o=s.login(e,t),o.then(function(e){return r.resolve(e),i()},function(e){return r.reject(e)}),r.promise},r.prototype.logout=function(){return u(),s.logout()},r}()),r.securityContext=l,i=function(){var e;return console.log("SecurityContext.getCurrentUser"),e=s.getCurrentUser(),e.then(function(e){return e?(console.log("Received current user from Ministry Platform"),l.user=e,l.userId=e.id,l.loggedIn=!0,l.seenDate=new Date,o.securityContext=e,o.seenDate=l.seenDate):(console.log("No current user logged in to Ministry Platform"),u())})},u=function(){return l.userId=null,l.user=null,l.loggedIn=!1,l.seenDate=null,o.securityContext&&delete o.securityContext,o.seenDate?delete o.seenDate:void 0},l}]})}.call(this);